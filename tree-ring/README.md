# Description
Reimplementation of the Tree-Ring algorithm described in https://arxiv.org/abs/2305.20030.

# Environment setup
Set up conda environment:

```
conda env create -f environment.yml
conda activate tree-ring
```

Download data:

```
wget http://images.cocodataset.org/zips/val2017.zip
sudo apt install unzip
unzip val2017.zip
rm val2017.zip
```

### Numpy Version

If you receive a message like this during your run:

```bash
  File "/home/<USERNAME>/.local/lib/python3.10/site-packages/pandas/_libs/__init__.py", line 18, in <module>
    from pandas._libs.interval import Interval
  File "interval.pyx", line 1, in init pandas._libs.interval
ValueError: numpy.dtype size changed, may indicate binary incompatibility. Expected 96 from C header, got 88 from PyObject
```

We found that installing `numpy==1.26.4` fixes the issue and allows the run to proceed. See more details [here](https://stackoverflow.com/a/78701492).

# Reproducing Results

Commands to run:
 1. `python apply_tree_ring.py` (`--visualize_keys` to save key visualizations)
 2. `python eval_tree_ring.py` (evaluate with no attacks)
 3. `python eval_tree_ring.py --attack rotation` (evaluate with 75 degree rotation)
 4. `python eval_tree_ring.py --attack blur` (evaluate with radius 4 Gaussian blurring)
 5. `python apply_tree_ring.py --key_file example_good_key.pt --num_files_to_process 1000 --output_folder outputs_single_key` (generate tree-ring images with good key)
 6. `python eval_tree_ring.py --results_folder outputs_single_key` (evaluate with single key)
 7. (Optional) `python get_reversed_latents.py --save_visualizations_instead` to visualize renoised latents

# Generate Tree-Ring Images
```python apply_tree_ring.py```

Inputs:
```
Options:
  --hf_dataset TEXT               Dataset you are working with.  [default:
                                  phiyodr/coco2017]
  --split TEXT                    Split to use  [default: validation]
  --output_folder TEXT            Folder to put results in.  [default:
                                  outputs]
  --channel INTEGER               Channel to put tree-ring watermark in.
                                  [default: 0]
  --num_files_to_process INTEGER  The number of files to actually process.
                                  [default: -1]
  --resume                        Resume from previous run.  [default: False]
  --model TEXT                    Diffusion model to use  [default:
                                  stabilityai/stable-diffusion-2-1-base]
  --scheduler TEXT                Scheduler to use from
                                  [DPMSolverMultistepScheduler, DDIMScheduler]
                                  [default: DPMSolverMultistepScheduler]
  --visualize_keys                Save visualizations of the key in the
                                  fourier space.
  --key_file TEXT                 Key file to use for watermarking if want
                                  specific key.
  --help                          Show this message and exit.
```

Outputs:
```
outputs/
├── captions
|   └── text files with the caption used to generate each image
├── key_visualizations (if used --visualize_keys)
|   └── images of the key in the fourier space (separated by real and imaginary)
├── keys
|   ├── .pt files containing the keys used to watermark the images
|   └── can be loaded using torch.load()
├── masks
|   ├── .pt files containing the masks used to watermark the images
|   └── can be loaded using torch.load()
├── unwatermarked
|   └── unwatermarked images
├── watermarked
|   └── watermarked images
└── processed.txt
```

# Evaluate Tree-Ring
```python eval_tree_ring.py```

Inputs:
```
Options:
  --gt_folder TEXT       Path to ground truth folder  [default: val2017]
  --results_folder TEXT  Path to results folder from apply_tree_ring.py
                         [default: outputs/]
  --attack TEXT          Attack to evaluate against from [none, rotation,
                         blur]  [default: none]
  --model TEXT           Diffusion model to use  [default: stabilityai/stable-
                         diffusion-2-1-base]
  --resume               Resume from previous run.
  --scheduler TEXT       Scheduler to use from [DPMSolverMultistepScheduler,
                         DDIMScheduler]  [default:
                         DPMSolverMultistepScheduler]
  --help                 Show this message and exit.
```

Outputs:
 - eval_probs_unwatermarked.csv: p-values for the unwatermarked images
 - eval_probs_watermarked.csv: p-values for the watermarked images
 - eval_probs.csv: p-values for both unwatermarked and watermarked images
 - in stdout: AUC, TPR@1%FPR, Unwatermarked FID, Watermarked FID

```python eval_from_file.py```

Evaluates AUC, TPR@1%FPR, and TPR@0.1%FPR from eval_probs.csv file generated by eval_tree_ring.py.

Input:
```
Options:
  --eval_file TEXT  Path to evaluation file generated by eval_tree_ring.py.
                    [default: eval_probs.csv]
  --help            Show this message and exit.
```

Output: AUC, TPR@1%FPR, TPR@0.1%FPR

# Get reversed latents
```python get_reversed_latents.py```

Helper file for extracting the reversed latents.

Inputs:
```
Options:
  --processed_file TEXT          Path to processed.txt  [default:
                                 outputs/processed.txt]
  --unwatermarked_folder TEXT    Path to unwatermarked images folder
                                 [default: outputs/unwatermarked]
  --watermarked_folder TEXT      Path to watermarked images folder  [default:
                                 outputs/watermarked]
  --output_folder TEXT           Folder to output reversed latents to
                                 [default: reversed_latents]
  --save_visualizations_instead  Whether to only save the visualizations of
                                 the latents
  --resume                       Resume from previous run.  [default: True]
  --model TEXT                   Diffusion model to use  [default:
                                 stabilityai/stable-diffusion-2-1-base]
  --scheduler TEXT               Scheduler to use from
                                 [DPMSolverMultistepScheduler, DDIMScheduler]
                                 [default: DPMSolverMultistepScheduler]
  --help                         Show this message and exit.
```

# References
## Tree-Ring
```bibtex
@misc{wen2023treeringwatermarksfingerprintsdiffusion,
      title={Tree-Ring Watermarks: Fingerprints for Diffusion Images that are Invisible and Robust}, 
      author={Yuxin Wen and John Kirchenbauer and Jonas Geiping and Tom Goldstein},
      year={2023},
      eprint={2305.20030},
      archivePrefix={arXiv},
      primaryClass={cs.LG},
      url={https://arxiv.org/abs/2305.20030}, 
}
```
