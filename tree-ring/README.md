# Environment setup
Set up conda environment:

```
conda env create -f environment.yml
conda activate tree-ring
```

Download data:

```
wget http://images.cocodataset.org/zips/val2017.zip
unzip val2017.zip
```

# Generate Tree-Ring Images
```python apply_tree_ring.py```

Inputs:
```
Options:
  --hf_dataset TEXT               Dataset you are working with.  [default:
                                  phiyodr/coco2017]
  --split TEXT                    Split to use  [default: validation]
  --output_folder TEXT            Folder to put results in.  [default:
                                  outputs]
  --channel INTEGER               Channel to put tree-ring watermark in.
                                  [default: 0]
  --num_files_to_process INTEGER  The number of files to actually process.
                                  [default: -1]
  --resume                        Resume from previous run.  [default: True]
  --help                          Show this message and exit.
```

Outputs:
```
outputs/
├── captions
|   └── text files with the caption used to generate each image
├── keys
|   ├── .pt files containing the keys used to watermark the images
|   └── can be loaded using torch.load()
├── masks
|   ├── .pt files containing the masks used to watermark the images
|   └── can be loaded using torch.load()
├── unwatermarked
|   └── unwatermarked images
├── watermarked
|   └── watermarked images
└── processed.txt
```

# Evaluate Tree-Ring
```python eval_tree_ring.py```

Inputs:
```
Options:
  --processed_file TEXT        Path to processed.txt  [default: outputs/processed.txt]
  --gt_folder TEXT             Path to ground truth folder  [default: val2017]
  --unwatermarked_folder TEXT  Path to unwatermarked images folder  [default: outputs/unwatermarked]
  --watermarked_folder TEXT    Path to watermarked images folder  [default: outputs/watermarked]
  --keys_folder TEXT           Path to keys folder  [default: outputs/keys]
  --masks_folder TEXT          Path to masks folder  [default: outputs/masks]
  --attack TEXT                Attack to evaluate against from [rotation, blur]
  --help                       Show this message and exit.
```

Outputs:
 - eval_probs_unwatermarked.csv: p-values for the unwatermarked images
 - eval_probs_watermarked.csv: p-values for the watermarked images
 - eval_probs.csv: p-values for both unwatermarked and watermarked images
 - in stdout: AUC, TPR@1%FPR, Unwatermarked FID, Watermarked FID

```python eval_from_file.py```

Evaluates AUC, TPR@1%FPR, and TPR@0.1%FPR from eval_probs.csv file generated by eval_tree_ring.py.

Input:
```
Options:
  --eval_file TEXT  Path to evaluation file generated by eval_tree_ring.py.
                    [default: eval_probs.csv]
  --help            Show this message and exit.
```

Output: AUC, TPR@1%FPR, TPR@0.1%FPR

# Get reversed latents
```python get_reversed_latents.py```

Helper file for extracting the reversed latents.

Inputs:
```
Options:
  --processed_file TEXT        Path to processed.txt  [default: outputs/processed.txt]
  --unwatermarked_folder TEXT  Path to unwatermarked images folder  [default: outputs/unwatermarked]
  --watermarked_folder TEXT    Path to watermarked images folder  [default: outputs/watermarked]
  --output_folder TEXT         Folder to output reversed latents to  [default: reversed_latents]
  --resume                     Resume from previous run.  [default: True]
  --help                       Show this message and exit.
```

# References
## Tree-Ring
```bibtex
@misc{wen2023treeringwatermarksfingerprintsdiffusion,
      title={Tree-Ring Watermarks: Fingerprints for Diffusion Images that are Invisible and Robust}, 
      author={Yuxin Wen and John Kirchenbauer and Jonas Geiping and Tom Goldstein},
      year={2023},
      eprint={2305.20030},
      archivePrefix={arXiv},
      primaryClass={cs.LG},
      url={https://arxiv.org/abs/2305.20030}, 
}
```